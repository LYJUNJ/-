<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zxx" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>在线会诊 - 实时聊天</title>
    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/cropped-favicon-32x32.png"/>
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="/assets/css/style.css" rel="stylesheet" type="text/css"/>
    <link href="/assets/css/plugin.css" rel="stylesheet" type="text/css"/>
    <link href="/assets/css/dashboard.css" rel="stylesheet" type="text/css"/>
    <link href="/assets/fonts/flaticon.css" rel="stylesheet" type="text/css"/>
    <link href="/assets/css/icons.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/assets/fonts/line-icons.css" type="text/css"/>
    <link rel="stylesheet" href="/common/font-awesome/css/font-awesome.min.css">
    <style>
        #chatBox {
            height: 350px;
            overflow-y: auto;
            border: 1px solid #e3e3e3;
            background: #fafbfc;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }
        .chat-msg {
            display: flex;
            align-items: flex-end;
            margin: 12px 0;
        }
        .chat-msg.self {
            flex-direction: row-reverse;
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #eee;
            margin: 0 10px;
            object-fit: cover;
        }
        .chat-bubble {
            max-width: 60%;
            padding: 10px 16px;
            border-radius: 16px;
            background: #e6f7ff;
            color: #333;
            position: relative;
            word-break: break-word;
            white-space: pre-wrap;
            overflow: visible;
            text-overflow: clip;
            display: block;
            max-width: 15em;
            width: max-content;
            line-height: 1.5;        /* 增加行高提高可读性 */
            padding: 8px 12px;       /* 适当的内边距 */
            margin: 4px 0;           /* 外边距 */
            border-radius: 4px;
        }
        .chat-msg.self .chat-bubble {
            background: #d1e7dd;
            color: #222;
        }
        .chat-meta {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
            text-align: right;
        }
    </style>
</head>
<body>
<div th:replace="common/common-bar::#header"></div>
<section class="container py-5">
    <h2 class="mb-4">实时会诊</h2>
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-9 col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">实时会诊</h4>
                    <button id="endConsultBtn" class="btn btn-danger btn-sm" style="display:none;">结束会诊</button>
                </div>
                <div class="card-body">
                    <div id="chatBox"></div>
                    <div class="input-group">
                        <input type="text" id="msgInput" class="form-control" placeholder="输入消息...">
                        <button class="btn btn-primary" id="sendBtn">发送</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<div th:replace="common/common-bar::#footer"></div>
<script src="/assets/js/jquery-3.5.1.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/plugin.js"></script>
<script src="/assets/js/main.js"></script>
<script src="/assets/js/custom-swiper.js"></script>
<script src="/assets/js/custom-nav.js"></script>
<script src="/common/utils/reg.js"></script>
<script src="/common/layer/layer.js"></script>
<script src="/common/custom.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
<script>
let stompClient = null;
let doctorId = getQueryVariable('doctorId');
let userId = getQueryVariable('userId');
let role = getQueryVariable('role'); // 'doctor' or 'user'
let myId = role === 'doctor' ? doctorId : userId;
let chatChannel = '/topic/chat/' + doctorId + '_' + userId;
console.log('订阅频道:', chatChannel); // 调试用

function connect() {
    let socket = new SockJS('/ws/consult');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
        stompClient.subscribe(chatChannel, function (msg) {
            let message = JSON.parse(msg.body);
            // 新增：判断是否为会诊结束消息
            if (message.type === 'end') {
                // 在聊天区下方插入提示
                $('#chatBox').append(
                    '<div class="alert alert-warning text-center mt-3" style="font-weight:bold;">此次会诊已结束</div>' +
                    '<div class="text-center mt-2"><a href="/my-visit" class="btn btn-info">我的就诊</a></div>'
                );
                $('#msgInput').prop('disabled', true);
                $('#sendBtn').prop('disabled', true);
                $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);
                return;
            }
            // 只显示对方发来的消息
            if (message.from != myId) {
                showMessage(message, false);
            }
        });
    });
}

function sendMsg() {
    let content = $('#msgInput').val();
    if (!content) return;
    let msg = {
        from: myId,
        to: role === 'doctor' ? userId : doctorId,
        content: content,
        time: new Date().toLocaleTimeString(),
        doctorId: doctorId,
        userId: userId
    };
    stompClient.send('/app/chat', {}, JSON.stringify(msg));
    showMessage(msg, true); // 只本地显示自己发的消息
    $('#msgInput').val('');
}

function showMessage(msg, isSelf) {
    // 可根据角色自定义头像
    let avatar = isSelf
        ? (role === 'doctor' ? '/assets/images/team/doctor-avatar.jpg' : '/assets/images/team/user-1.jpg')
        : (role === 'doctor' ? '/assets/images/team/user-1.jpg' : '/assets/images/team/doctor-avatar.jpg');
    let html = `<div class="chat-msg${isSelf ? ' self' : ''}">
        <img class="chat-avatar" src="${avatar}" alt="头像"/>
        <div>
            <div class="chat-bubble">${msg.content}</div>
            <div class="chat-meta">${msg.time}</div>
        </div>
    </div>`;
    $('#chatBox').append(html).scrollTop($('#chatBox')[0].scrollHeight);
}

$('#sendBtn').click(sendMsg);
$('#msgInput').keypress(function(e){ if(e.which==13) sendMsg(); });
$(function(){ connect(); });

function getQueryVariable(variable) {
    let query = window.location.search.substring(1);
    let vars = query.split("&");
    for (let i=0;i<vars.length;i++) {
        let pair = vars[i].split("=");
        if(pair[0] == variable){return pair[1];}
    }
    return(false);
}

// 只在医生端显示结束会诊按钮
if (role === 'doctor') {
    $('#endConsultBtn').show();
}
$('#endConsultBtn').click(endConsult);

function endConsult() {
    // 调用后端接口结束会诊
    $.post('/docHistory/endConsult', {doctorId: doctorId, userId: userId}, function(res) {
        if(res.code === 'SUCCESS') {
            window.location.href = '/my-consult';
        } else {
            layer.msg(res.message || '结束会诊失败');
        }
    });
}
</script>
</body>
</html>
